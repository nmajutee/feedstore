---
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { categories, products } from '../../../data/products';

export function getStaticPaths() {
  return categories.flatMap(category =>
    category.subCategories.map(sub => ({
      params: { category: category.slug, subcategory: sub.slug },
      props: { category, subCategory: sub },
    }))
  );
}

const { category, subCategory } = Astro.props;
const subCategoryProducts = products.filter(p =>
    p.topCategory === category.slug && p.subCategory === subCategory.slug
);

const schema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `${subCategory.name} - ${category.name}`,
  "description": `Browse our selection of ${subCategory.name} products under ${category.name}.`,
  "url": `https://agropro-feed.com/${category.slug}/${subCategory.slug}`,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": subCategoryProducts.map((product, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": `https://agropro-feed.com/${category.slug}/${subCategory.slug}/${product.slug}`,
      "name": product.name
    }))
  }
};
---

<Layout 
  title={`${subCategory.name} - ${category.name} - AgroPro`}
  description={`Shop high-quality ${subCategory.name} for ${category.name} at AgroPro. Expert nutrition for your livestock.`}
  canonical={`https://agropro-feed.com/${category.slug}/${subCategory.slug}`}
  schema={schema}
>
   <div class="full_bg">
      <Header />
   </div>

   <!-- products -->
   <div class="services">
      <div class="container">
         <div class="row">
            <div class="col-md-12">
               <div class="titlepage text_align_left">
                  <span>{category.name}</span>
                  <h2>{subCategory.name}</h2>
                  <p>Browse our selection of {subCategory.name} products.</p>
                  <a href={`/${category.slug}`} class="read_more" style="margin-top: 20px; width: auto; padding: 0 20px; height: 40px; line-height: 40px; font-size: 14px;">&larr; Back to {category.name}</a>
               </div>
            </div>
         </div>

         <div class="row">
            {subCategoryProducts.length > 0 ? (
                subCategoryProducts.map((product) => (
                <div class="col-md-4">
                <div class="services_box_main">
                    <div  class="services_box text_align_left">
                        <figure>
                            {product.image ? (
                                <img src={product.image} alt={product.name}/>
                            ) : (
                                <div style="width: 100%; height: 200px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #adb5bd;">
                                    No Image
                                </div>
                            )}
                        </figure>
                        <div class="veget">
                            <h3>{product.name}</h3>
                            <p>{product.description}</p>
                        </div>
                    </div>
                    <a class="read_more" href={`/${category.slug}/${subCategory.slug}/${product.slug}`}>View Details</a>
                </div>
                </div>
                ))
            ) : (
                <div class="col-md-12">
                    <p>No products found in this subcategory yet.</p>
                </div>
            )}
         </div>
      </div>
   </div>
   <!-- end products -->

   <Footer />
</Layout>
