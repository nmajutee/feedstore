---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProductCard from '../../components/ProductCard.astro';
import SidebarFilter from '../../components/SidebarFilter.astro';
import { categories, products } from '../../data/products';

export function getStaticPaths() {
  return categories.map(category => ({
    params: { category: category.slug },
    props: { category },
  }));
}

const { category } = Astro.props;
const categoryProducts = products.filter(p => p.topCategory === category.slug);

// Extract unique filter values
const animals = [...new Set(categoryProducts.map(p => p.animal))].filter(Boolean);
const weights = [...new Set(categoryProducts.map(p => p.weight))].filter(Boolean);
const prices = categoryProducts.map(p => p.price);
const minPrice = prices.length ? Math.min(...prices) : 0;
const maxPrice = prices.length ? Math.max(...prices) : 0;

const schema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": category.name,
  "description": category.description,
  "url": Astro.url.href,
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": categoryProducts.map((product, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "url": new URL(`/${category.slug}/${product.slug}`, Astro.site).href,
      "name": product.name
    }))
  }
};
---

<Layout
  title={`${category.name} - Premium Feed | AgroPro`}
  description={category.description}
  schema={schema}
>
   <Header />

   <div class="page-header" style={category.image ? `background-image: url('${category.image}'); background-size: cover; background-position: center; position: relative;` : ''}>
      {category.image && <div class="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);"></div>}
      <div class="container" style="position: relative; z-index: 1;">
         <div class="row">
            <div class="col-md-12">
               <div class="titlepage text_align_left">
                  <span style={category.image ? 'color: #f8f9fa;' : ''}>Category</span>
                  <h2 style={category.image ? 'color: #fff;' : ''}>{category.name}</h2>
                  <p style={category.image ? 'color: #f8f9fa;' : ''}>{category.description}</p>
               </div>
            </div>
         </div>
      </div>
   </div>

   <div class="section-padding">
      <div class="container">
         <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 mb-4">
               <SidebarFilter
                  animals={animals}
                  weights={weights}
                  minPrice={minPrice}
                  maxPrice={maxPrice}
               />
            </div>

            <!-- Product Grid -->
            <div class="col-lg-9">
               <div class="row g-3 g-md-4">
                  {categoryProducts.length > 0 ? (
                      categoryProducts.map((product) => (
                      <div class="col-12 col-sm-6 col-lg-4">
                          <ProductCard product={product} />
                      </div>
                      ))
                  ) : (
                      <div class="col-12">
                          <p>No products found in this category.</p>
                      </div>
                  )}
               </div>
            </div>
         </div>
      </div>
   </div>

   <Footer />
</Layout>
